{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block translationFolder %}data-translation-folder="profile"{% endblock %}
{% block title %}Profile{% endblock %}

{% block content %}

<!-- Toggle Button -->
<div class="container text-end mt-3">
    <button class="btn btn-link" id="toggleProfileHeader">
        <i class="fas fa-chevron-up" id="toggleIcon"></i>
    </button>
</div>

<!-- Profile Header Section -->
<div class="container profile-header p-4 mb-4 text-center" id="profileHeader">
    <!-- User Image -->
    <div class="d-flex justify-content-center">
        {% if request.user.image %}
            <img src="{{ request.user.image.url }}" alt="User" class="rounded-circle" style="width: 100px; height: 100px;" />
        {% else %}
            <img src="{% static 'imgs/defaults/person.svg' %}" alt="User" class="rounded-circle" style="width: 100px; height: 100px;" />
        {% endif %}
    </div>

    <!-- User Name -->
    <h4 class="text-primary fw-bold mt-3">{{ request.user.name|default:request.user.username }}</h4>

    <!-- Profile Info -->
    <div class="profile-info row mt-3 justify-content-center">
        <div class="col-12 col-md-4">
            <p><span class="info-title fw-bold" data-translate="email">Email:</span> {{ request.user.email|default:'N/A' }}</p>
        </div>
        <div class="col-12 col-md-4">
            <p><span class="info-title fw-bold" data-translate="role">Role:</span> {{ request.user.get_role_display }}</p>
        </div>
        {% if request.user.role == 'student' %}
            <div class="col-12 col-md-4">
                <p><span class="info-title fw-bold" data-translate="age">Age:</span> {{ request.user.studentprofile.age }}</p>
            </div>
            <div class="col-12 col-md-4">
                <p><span class="info-title fw-bold" data-translate="parent_phone">Parent Phone:</span> {{ request.user.studentprofile.parent_phone|default:'N/A' }}</p>
            </div>
        {% elif request.user.role == 'teacher' %}
            <div class="col-12 col-md-4">
                <p><span class="info-title fw-bold" data-translate="phone">Phone:</span> {{ request.user.phone|default:'N/A' }}</p>
            </div>
        {% endif %}
        <div class="col-12 text-center mt-3">
            <button class="btn btn-primary" data-mdb-toggle="modal" data-mdb-target="#editProfileModal" data-translate="edit_profile">Edit Profile</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel" data-translate="edit_profile">Edit Profile</h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" method="post" action="{% url 'accounts:edit_profile' %}">
                        {% csrf_token %}
                        <div class="mb-3 form-outline">
                            <input type="email" class="form-control" id="email" name="email" value="{{ request.user.email }}" required>
                            <label for="email" class="form-label" data-translate="email">Email</label>
                        </div>
                        {% if request.user.role == 'student' %}
                            <div class="mb-3 form-outline">
                                <input type="number" class="form-control" id="age" name="age" value="{{ request.user.studentprofile.age }}" required>
                                <label for="age" class="form-label" data-translate="age">Age</label>
                            </div>
                            <div class="mb-3 form-outline">
                                <input type="text" class="form-control" id="parent_phone" name="parent_phone" value="{{ request.user.studentprofile.parent_phone }}" required>
                                <label for="parent_phone" class="form-label" data-translate="parent_phone">Parent Phone</label>
                            </div>
                        {% elif request.user.role == 'teacher' %}
                            <div class="mb-3 form-outline">
                                <input type="text" class="form-control" id="phone" name="phone" value="{{ request.user.phone }}" required>
                                <label for="phone" class="form-label" data-translate="phone">Phone</label>
                            </div>
                        {% endif %}
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" data-translate="save_changes">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="schedulingModal" tabindex="-1" aria-labelledby="schedulingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schedulingModalLabel" data-translate="schedule_appointment">Schedule Appointment</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <input type="hidden" id="subscriptionId" name="subscription_id">
                    

                    <!-- Available Work Days -->
                    <h6 class="mt-3" data-translate="select_day_message">Available Work Days</h6>
                    <div class="schedule-options d-flex flex-wrap" id="day-options">
                        <div class="schedule-option " data-type="day" data-day="sunday" data-translate="sunday">Sunday</div>
                        <div class="schedule-option " data-type="day" data-day="monday" data-translate="monday">Monday</div>
                        <div class="schedule-option " data-type="day" data-day="tuesday" data-translate="tuesday">Tuesday</div>
                        <div class="schedule-option " data-type="day" data-day="wednesday" data-translate="wednesday">Wednesday</div>
                        <div class="schedule-option " data-type="day" data-day="thursday" data-translate="thursday">Thursday</div>
                        <div class="schedule-option " data-type="day" data-day="friday" data-translate="friday">Friday</div>
                        <div class="schedule-option " data-type="day" data-day="saturday" data-translate="saturday">Saturday</div>
                    </div>

                    <!-- Available Work Times -->
                    <h6 class="mt-4" data-translate="available_times_message">Available Work Times</h6>
                    <div class="schedule-options" id="time-options">
                        <!-- Times will be dynamically populated based on the selected day -->
                    </div>

                    <!-- Info Tip -->
                    <p class="info-tip mt-3" id="infoTip" data-translate="select_dat_first_message">Please select a day first.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAppointment" data-translate="save_appointment">Save Appointment</button>
            </div>
        </div>
    </div>
</div>


{% if request.user.role == 'teacher' %}
<section class="container py-5">
    <!-- Filter and Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <!-- Day Filter -->
                <div class="col-md-3">
                    <div class="form-outline">
                        <select name="day" id="day" class="form-select">
                            <option value="" data-translate="all_days">All Days</option>
                            {% for day in days_of_week %}
                                <option value="{{ day }}" data-translate="{{ day|lower }}" {% if day == request.GET.day %}selected{% endif %}>{{ day }}</option>
                            {% endfor %}
                        </select>
                        
                    </div>
                </div>
    
                <!-- Status Filter -->
                <div class="col-md-3">
                    <div class="form-outline">
                        <select name="status" id="status" class="form-select">
                            <option value="" data-translate="all_statuses">All Statuses</option>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" data-translate="{{ label|lower }}" {% if value == request.GET.status %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        
                    </div>
                </div>
    
                <!-- Search Input -->
                <div class="col-md-4">
                    <div class="form-outline">
                        <input type="text" name="search" id="search" class="form-control "  value="{{ request.GET.search }}">
                        <label class="form-label" for="search" data-translate="search_placeholder">Search</label>
                    </div>
                </div>
    
                <!-- Apply Button -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100" data-translate="apply_filter">
                        <i class="fas fa-filter me-2"></i> Apply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Appointments by Day -->
<!-- Appointments by Day -->
{% for day, appointments in organized_appointments.items %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0 text-light" data-translate="{{ day|lower }}">{{ day|title }}</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th data-translate="student">Student</th>
                            <th data-translate="course">Course</th>
                            <th data-translate="time">Time</th>
                            <th data-translate="progress">Progress</th>
                            <th data-translate="status">Status</th>
                            <th data-translate="show">Show</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in appointments %}
                            <tr>
                                <td>{{ appointment.subscription.student.name }}</td>
                                <td>{{ appointment.subscription.course.name }}</td>
                                <td>{{ appointment.avialability.start_time }} - {{ appointment.avialability.end_time }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2">
                                            <div class="progress-bar 
                                                {% if appointment.progress < 50 %}bg-danger
                                                {% elif appointment.progress < 80 %}bg-warning
                                                {% else %}bg-success{% endif %}" 
                                                role="progressbar" style="width: {{ appointment.progress }}%;" 
                                                aria-valuenow="{{ appointment.progress }}" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <span>{{ appointment.progress }}%</span>
                                    </div>
                                </td>
                                <td>
                                    {% if appointment.is_active %}
                                        <span class="badge badge-success" data-translate="active">Active</span>
                                    {% else %}
                                        <span class="badge badge-danger" data-translate="inactive">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a data-translate="show" href="{% url 'accounts:session_details' appointment.subscription.course.id appointment.subscription.student.username %}" class="btn btn-sm btn-primary">View</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% empty %}
    <div class="alert alert-info" data-translate="no_appointments">No appointments found.</div>
{% endfor %}



</section>
{% else %}


<!-- Student Profile Section -->
<section class="container py-5 ">
    <div class="card shadow-0">
        <div class="card-body">
            <div class="form-header text-center ">
                <h3 class="styled-title">
                    <span class="line"></span>
                    <span class="text">
                        <span class="icon"><i class="me-2 fas fa-chalkboard-user"></i></i></span>
                        <span data-translate="my_learning_journey">My Journey </span>
                    </span>
                    <span class="line"></span>
                </h3>
            </div>

            <!-- Main Content -->
            <div class="row">
                <!-- Level Pills -->
                <div class="col-lg-3 mb-4">
                    <div class="list-group fw-bold" role="tablist">
                        {% for level in levels %}
                        <a class="list-group-item list-group-item-action px-3 border-0 ripple {% if forloop.first %}active{% endif %}"
                           data-mdb-toggle="tab"
                           href="#level-{{ level.id }}"
                           role="tab">
                            {{ level.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Content Area -->
                <div class="col-lg-9">
                    <div class="tab-content">
                        {% for level in levels %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                             id="level-{{ level.id }}" 
                             role="tabpanel">
                            
                            <!-- Toggle Buttons -->
                            <ul class="nav nav-tabs justify-content-center mb-4" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link fw-bold active" 
                                            data-mdb-toggle="tab"
                                            data-mdb-target="#courses-{{ level.id }}"
                                            type="button"
                                            role="tab"
                                            data-translate="ind-courses">
                                        Individual Courses
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link fw-bold" 
                                            data-mdb-toggle="tab"
                                            data-mdb-target="#tracks-{{ level.id }}"
                                            type="button"
                                            role="tab"
                                            data-translate="tracks">
                                        Tracks
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content">
                                <!-- Individual Courses -->
                                <div class="tab-pane fade show active" 
                                     id="courses-{{ level.id }}" 
                                     role="tabpanel">
                                    {% if level.individual_courses %}
                                        <div class="row g-4">
                                            {% for course_data in level.individual_courses %}
                                                <div class="col-12">
                                                    {% include 'accounts/partials/course_card.html' with course_data=course_data %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-primary text-center">
                                            No individual courses available for this level.
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Tracks -->
                                <div class="tab-pane fade" 
                                     id="tracks-{{ level.id }}" 
                                     role="tabpanel">
                                    {% if level.tracks %}
                                        {% for track in level.tracks %}
                                            <div class="mb-4">
                                                <h5 class="fw-bold mb-3">{{ track.name }}</h5>
                                                <div class="row g-4">
                                                    {% for course_data in track.courses %}
                                                        <div class="col-12">
                                                            {% include 'accounts/partials/course_card.html' with course_data=course_data %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-primary text-center">
                                            No tracks available for this level.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dayOptions = document.querySelectorAll('#day-options .schedule-option');
        const timeOptionsContainer = document.getElementById('time-options');
        const infoTip = document.getElementById('infoTip');
        let selectedDay = null;
        const modalElement = document.getElementById('schedulingModal');
        const subscriptionInput = document.getElementById('subscriptionId');
        const appointmentForm = document.getElementById('appointmentForm');
    
        // Attach event listener to the modal open event
    modalElement.addEventListener('show.bs.modal', function(event) {
        // Get the button that triggered the modal
        const button = event.relatedTarget;

        // Extract the subscription ID from the button's data attributes
        const subscriptionId = button.getAttribute('data-subscription-id');

        // Set the subscription ID in the hidden input field
        if (subscriptionInput) {
            subscriptionInput.value = subscriptionId;
        }
    });

    // Attach event listener to reset the form on modal close
    modalElement.addEventListener('hidden.bs.modal', function() {
        // Reset the form
        if (appointmentForm) {
            appointmentForm.reset();
        }

        // Clear dynamically populated fields (if needed)
        const dayOptions = document.querySelectorAll('#day-options .schedule-option');
        dayOptions.forEach(option => option.classList.remove('selected'));

        const timeOptionsContainer = document.getElementById('time-options');
        if (timeOptionsContainer) {
            timeOptionsContainer.innerHTML = '';
        }

        const infoTip = document.getElementById('infoTip');
        if (infoTip) {
            infoTip.style.display = 'block';
        }
    });
    
        // Handle day selection
        dayOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selection from all days
                dayOptions.forEach(opt => opt.classList.remove('selected'));
                // Add selection to the clicked day
                this.classList.add('selected');
                selectedDay = this.dataset.day;
                let subscription_id = document.getElementById('subscriptionId').value
                // Fetch available time slots for the selected day
                fetchAvailableTimeSlots(selectedDay,subscription_id);
    
                // Show info tip if no day is selected
                if (selectedDay) {
                    infoTip.style.display = 'none';
                } else {
                    infoTip.style.display = 'block';
                }
            });
        });
    
        // Function to fetch available time slots for the selected day
        function fetchAvailableTimeSlots(day, subscription_id) {
        
            fetch(`/accounts/get-available-slots/?day=${day}&subscription_id=${subscription_id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch available slots.');
                    }
                    return response.json();
                })
                .then(data => {
                    timeOptionsContainer.innerHTML = '';
        
                    data.available_times.forEach(slot => {
                        const option = document.createElement('div');
                        option.classList.add('schedule-option');
                        option.dataset.type = 'time';
                        option.dataset.timeSlot = `${slot.start}-${slot.end}`;
                        option.textContent = `${slot.start} - ${slot.end}`;
                        timeOptionsContainer.appendChild(option);
                    });
        
                    // Handle time selection
                    const timeOptions = document.querySelectorAll('#time-options .schedule-option');
                    timeOptions.forEach(option => {
                        option.addEventListener('click', function() {
                            timeOptions.forEach(opt => opt.classList.remove('selected'));
                            this.classList.add('selected');
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching time slots:', error);
                    alert('Unable to fetch time slots. Please try again later.');
                });
        }
        
    
        // Handle save button click
        document.getElementById('saveAppointment').addEventListener('click', function() {
            
            const selectedTimeOption = document.querySelector('#time-options .schedule-option.selected');
    
            if (!selectedDay || !selectedTimeOption) {
                appointmentForm.reportValidity();
                return;
            }
    
            const timeSlot = selectedTimeOption.dataset.timeSlot;
            const [startTime, endTime] = timeSlot.split('-');
    
            fetch('/accounts/create-appointment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    subscription_id: document.getElementById('subscriptionId').value,
                    
                    day: selectedDay,
                    start_time: startTime,
                    end_time: endTime,
                }),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Network response was not ok');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Close the modal
                    const modal = document.getElementById('schedulingModal');
                    const modalInstance = mdb.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
    
                    // Show success message
                    alert(data.message || 'Appointment successfully created!');
                    
                    // Reload the page
                    location.reload();
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while creating the appointment');
            });
        });
        
    
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggleProfileHeader');
        const profileHeader = document.getElementById('profileHeader');
        const toggleIcon = document.getElementById('toggleIcon');
        
        // Get saved state from localStorage
        const isVisible = localStorage.getItem('profileHeaderVisible') !== 'false';
        
        // Set initial state
        profileHeader.style.display = isVisible ? 'block' : 'none';
        toggleIcon.className = isVisible ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        
        toggleBtn.addEventListener('click', function() {
            const isCurrentlyVisible = profileHeader.style.display !== 'none';
            profileHeader.style.display = isCurrentlyVisible ? 'none' : 'block';
            toggleIcon.className = isCurrentlyVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            
            // Save state to localStorage
            localStorage.setItem('profileHeaderVisible', !isCurrentlyVisible);
        });
    });
</script>
    

{% endblock %}
