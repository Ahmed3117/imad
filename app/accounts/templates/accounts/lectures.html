{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block translationFolder %}data-translation-folder="lectures"{% endblock %}
{% block title %}Lectures{% endblock %}




{% block content %}

<style>
    .active-lecture{
        background-color: #fff0f0; /* light red background */
        border-left: 4px solid #28a745; /* red border */
    }
    
    .active-lecture .accordion-button {
        color: #28a745; /* red text */
    }


    .finished-lecture {
        background-color: #f0fff0; /* light green background */
        border-left: 4px solid #dc3545; /* green border */
    }
    
    .finished-lecture .accordion-button {
        color: #dc3545; /* green text */
    }
</style>

<!-- Optional: Add custom CSS in your static files or <style> block -->
    <style>
        .lecture-accordion .accordion-button:not(.collapsed) {
            /* Example: Subtle highlight for the open item's button */
            /* background-color: rgba(0, 0, 0, 0.03); */
        }
        .lecture-accordion .finished-lecture .accordion-button {
           /* Style for finished lecture header - e.g., slightly muted */
           opacity: 0.75;
        }
        /* Add a subtle left border indicator for state */
        .lecture-accordion .active-lecture > .accordion-header {
            border-left: 4px solid var(--mdb-primary, #3b71ca); /* MDB Primary */
        }
        .lecture-accordion .finished-lecture > .accordion-header {
           border-left: 4px solid var(--mdb-secondary, #9fa6b2); /* MDB Secondary */
        }
        /* Ensure header border aligns with item */
        .lecture-accordion .accordion-header {
            border-top-left-radius: inherit;
            border-bottom-left-radius: inherit;
        }
        /* Style for file list items */
        .file-list-item {
            background-color: rgba(0, 0, 0, 0.03);
            transition: background-color 0.2s ease-in-out;
        }
        .file-list-item:hover {
            background-color: rgba(0, 0, 0, 0.06);
        }
        .file-icon-wrapper {
            width: 40px;
            height: 40px;
            flex-shrink: 0; /* Prevent icon shrinking */
            background-color: rgba(var(--mdb-secondary-rgb), 0.1); /* Use MDB color variable */
        }
        /* Ensure action buttons wrap nicely */
        .lecture-actions .btn-group-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem; /* Spacing between buttons */
            align-items: center;
        }
        .modal-rating-select option {
            padding: 5px; /* Add some padding to star options */
        }
    </style>
    


<div class="container mt-5">

    <!-- Assignments Report Button -->
    <div class="text-end mb-3">
        {% if request.user.role == "teacher" %}
        <a href="{% url 'assignment:studygroup_grades' study_group.id %}" class="btn btn-secondary text-light" data-translate="assignment_report">Assignments Report</a>
        {% else %}
        <a href="{% url 'assignment:student_grades' study_group.id request.user.id %}" class="btn btn-secondary text-light" data-translate="assignment_report">Assignments Report</a>
        {% endif %}
    </div>

    <!-- Shared Resources Section - Now Collapsible -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-light d-flex justify-content-between align-items-center"
             data-mdb-toggle="collapse"
             data-mdb-target="#sharedResourcesCollapse"
             aria-expanded="true"
             aria-controls="sharedResourcesCollapse"
             style="cursor: pointer;"
             id="sharedResourcesHeader">
            <h5 class="mb-0 text-light">
                <i class="fas fa-share-alt me-2"></i>
                <span data-translate="shared_resources">Shared Resources</span>
            </h5>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="collapse show" id="sharedResourcesCollapse">
            <div class="card-body">
                {% if shared_resources %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th data-translate="resource">Resource</th>
                                    <th data-translate="course">Course</th>
                                    <th data-translate="shared_by">Shared By</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for resource in shared_resources %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-file me-2"></i>
                                            {{ resource.resource.file.name|slice:"courseslibraries/:" }}
                                        </td>
                                        <td>{{ resource.resource.course.name }}</td>
                                        <td>{{ resource.shared_by.username }}</td>
                                        <td>
                                            <a href="{{ resource.resource.file.url }}"
                                            class="btn btn-sm btn-primary"
                                            target="_blank"
                                            data-translate="download">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                            {% if user_role == 'teacher' and resource.shared_by == request.user %}
                                                <button class="btn btn-sm btn-danger delete-resource-btn"
                                                        data-resource-id="{{ resource.id }}"
                                                        data-translate="delete">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0" data-translate="no_shared_resources">
                        <i class="fas fa-info-circle me-2"></i>
                        No resources have been shared with this study group yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if user_role == 'teacher' %}
    <div class="card mb-4 shadow-sm " >
        <div class="card-header d-flex justify-content-between align-items-center bg-primary"
             data-mdb-toggle="collapse"
             data-mdb-target="#addLectureFormCollapse"
             aria-expanded="true" 
             aria-controls="addLectureFormCollapse"
             style="cursor: pointer; "
             id="addLectureHeader"> 
            <h5 class="mb-0 text-light">
                <i class="fas fa-plus-circle me-2"></i>
                <span data-translate="add_lecture">Add New Lecture</span>
            </h5>
            <i class="fas fa-chevron-down toggle-icon"></i> 
        </div>
        <div class="collapse show" id="addLectureFormCollapse">
            <div class="card-body">
                <form id="add-lecture-form" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="add_lecture" value="1">
                    <div class="row g-3">
                        <div class="col-md-5">
                            <div class="form-floating">
                                <input type="text" id="{{ lecture_form.title.id_for_label }}" name="title" class="form-control" value="{{ lecture_form.title.value|default:'' }}" required>
                                <label class="form-label" for="{{ lecture_form.title.id_for_label }}" data-translate="title">Title</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="number" id="{{ lecture_form.duration.id_for_label }}" name="duration" class="form-control" value="{{ lecture_form.duration.value|default:60 }}" max="300" min="10" required>
                                <label class="form-label" for="{{ lecture_form.duration.id_for_label }}" data-translate="duration">Duration (minutes)</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select id="{{ lecture_form.schedule.id_for_label }}" name="schedule" class="form-select" required>
                                    {% for value, label in lecture_form.schedule.field.choices %}
                                        <option value="{{ value }}" {% if lecture_form.schedule.value == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <label class="form-label" for="{{ lecture_form.schedule.id_for_label }}" data-translate="schedule">Schedule</label>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-floating">
                                <textarea id="{{ lecture_form.description.id_for_label }}" name="description" class="form-control" rows="3" required>{{ lecture_form.description.value|default:'' }}</textarea>
                                <label class="form-label" for="{{ lecture_form.description.id_for_label }}" data-translate="description">Description</label>
                            </div>
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" id="add-lecture-button" class="btn btn-primary btn-block btn-rounded">
                                <span id="button-text" data-translate="add_lecture">Add Lecture</span>
                                <div id="loading-spinner" class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden" data-translate="loading">Loading...</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lectures List with MDB Accordion -->
    {% if lectures_with_files %}

    
    <div class="accordion lecture-accordion" id="lecturesAccordion">
        {% for lecture_data in lectures_with_files %}
        <div class="accordion-item lecture-item shadow-sm mb-3 border rounded-1 {% if lecture_data.lecture.is_finished %}finished-lecture{% else %}active-lecture{% endif %}" data-lecture-id="{{ lecture_data.lecture.id }}">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                <button
                    class="accordion-button collapsed fw-medium"
                    type="button"
                    data-mdb-collapse-init {# MDB Attribute #}
                    data-mdb-toggle="collapse"
                    data-mdb-target="#collapse{{ forloop.counter }}"
                    aria-expanded="false"
                    aria-controls="collapse{{ forloop.counter }}"
                >
                    <i class="fas fa-book-reader me-2 text-primary fa-fw"></i>
                    <span class="me-auto" data-translate="lecture_title">{{ lecture_data.lecture.title }}</span> {# Pushes badge right #}
    
                    {% if lecture_data.lecture.is_finished %}
                        <span class="badge rounded-pill bg-secondary ms-2" data-translate="finished">Finished</span>
                    {% endif %}
                </button>
            </h2>
            <div
                id="collapse{{ forloop.counter }}"
                class="accordion-collapse collapse"
                aria-labelledby="heading{{ forloop.counter }}"
                data-mdb-parent="#lecturesAccordion"
            >
                <div class="accordion-body p-lg-4 p-3"> {# Responsive Padding #}
                    <p class="text-muted mb-4 lecture-description" data-translate="lecture_description">
                        {{ lecture_data.lecture.description|default:"No description provided." }}
                    </p>
    
                    {# Responsive Row for Date & Live Link #}
                    <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mb-4 gap-3 border-bottom pb-3">
                        <div class="date-info text-muted small" data-translate="created_on">
                            <i class="far fa-calendar-alt me-1 fa-fw"></i>
                            <strong data-translate="created">Created:</strong>
                            {{ lecture_data.lecture.created_at|date:"M d, Y" }} {# Standard Django date filter #}
                        </div>
    
                        {% if lecture_data.lecture.live_link and not lecture_data.lecture.is_finished %}
                        <div class="live-session text-sm-end mt-2 mt-sm-0"> {# Align right on small+ screens #}
                            <a href="{{ lecture_data.lecture.live_link }}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary px-3 rounded-pill" data-mdb-ripple-init> {# MDB Ripple #}
                                <i class="fas fa-video me-1"></i>
                                <span data-translate="join_live_session">Join Live Session</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
    
                    <!-- Files Section -->
                    <div class="lecture-files mt-3">
                        <h6 class="mb-3 text-muted fw-bold text-uppercase small" data-translate="files">
                            <i class="fas fa-paperclip me-2 fa-fw"></i> <span>Files</span>
                        </h6>
                        {% if lecture_data.files %}
                            <ul class="list-unstyled mb-0" id="file-list-{{ lecture_data.lecture.id }}">
                                {% for file in lecture_data.files %}
                                <li class="d-flex align-items-center p-2 mb-2 file-list-item rounded-1 position-relative" data-file-id="{{ file.id }}">
                                    <div class="file-icon-wrapper rounded-circle d-flex align-items-center justify-content-center me-3">
                                        <i class="far fa-file-alt text-secondary fs-5"></i>
                                    </div>
                                    <div class="file-info flex-grow-1">
                                        <a href="{{ file.file.url }}" target="_blank" rel="noopener noreferrer" class="text-dark fw-medium stretched-link text-decoration-none">
                                            {{ file.file.name|split:"/"|last }}
                                        </a>
                                        
                                    </div>
                                    {% if user_role == 'teacher' %}
                                        <button class="btn btn-outline-danger btn-sm delete-file-btn ms-2 flex-shrink-0 position-relative z-index-1 rounded-circle p-0" style="width: 30px; height: 30px;" data-file-id="{{ file.id }}" title="Delete file" data-mdb-ripple-init data-mdb-ripple-color="dark" >
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted small fst-italic" data-translate="no_files">No files uploaded yet.</p>
                        {% endif %}
    
                        <!-- Add File Form (Teacher Only) -->
                        {% if user_role == 'teacher' %}
                            <form class="mt-3 file-upload-form" data-lecture-id="{{ lecture_data.lecture.id }}" method="POST" action="." enctype="multipart/form-data"> {# Assume action handled by JS or specific URL needed #}
                                {% csrf_token %}
                                <div class="input-group input-group-sm">
                                    <input type="file" name="file" class="form-control" multiple aria-label="Upload file" required>
                                    <button type="submit" class="btn btn-outline-primary" data-mdb-ripple-init>
                                        <i class="fas fa-upload me-1"></i> <span data-translate="upload_files">Upload</span>
                                    </button>
                                </div>
                            </form>
                        {% endif %}
                    </div>
    
                    <!-- Actions Section -->
                    <div class="lecture-actions mt-4 pt-3 border-top">
                        <div class="btn-group-actions"> {# Custom class for flex wrap defined in CSS #}
                            {% if user_role == 'teacher' %}
                                <button class="btn btn-sm btn-warning edit-lecture-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-mdb-ripple-init data-translate="edit">Edit</button>
                                <button class="btn btn-sm btn-secondary reschedule-lecture-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-mdb-ripple-init data-translate="reschedule">Reschedule</button>
                                {% if not lecture_data.lecture.is_finished %}
                                <button class="btn btn-sm btn-success mark-finished-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-mdb-ripple-init data-translate="mark_as_finished">Mark Finished</button>
                                {% endif %}
                                <a class="btn btn-sm btn-dark" href="{% url 'assignment:lecture_assignments' lecture_data.lecture.id %}" data-mdb-ripple-init data-translate="assignments">Assignments</a>
                                <!-- Note Button Trigger -->
                                <button type="button" class="btn btn-sm {% if lecture_data.note %}btn-info{% else %}btn-info{% endif %}" data-mdb-toggle="modal" data-mdb-target="#noteModal{{ lecture_data.lecture.id }}" data-mdb-ripple-init>
                                    <i class="far fa-comment-alt me-1"></i> <span data-translate="add_note">Feedback</span> {% if lecture_data.note %}<span class="badge bg-success rounded-pill ms-1 p-1"></span>{% endif %}
                                </button>
                                <button class="btn btn-sm btn-danger delete-lecture-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-mdb-ripple-init data-translate="delete">Delete</button>
    
                            {% elif user_role == 'student' %}
                                <a class="btn btn-sm btn-dark" href="{% url 'assignment:student_assignment_list' lecture_data.lecture.id %}" data-mdb-ripple-init data-translate="view_assignments">View Assignments</a>
                                <!-- Note Button Trigger -->
                                <button type="button" class="btn btn-sm {% if lecture_data.note %}btn-info{% else %}btn-info{% endif %}" data-mdb-toggle="modal" data-mdb-target="#noteModal{{ lecture_data.lecture.id }}" data-mdb-ripple-init>
                                    <i class="far fa-comment-alt me-1"></i> <span data-translate="add_note_and_rating">Add Note & Rating</span> {% if lecture_data.note %}<span class="badge bg-success rounded-pill ms-1 p-1" title="Note added"></span>{% endif %}
                                </button>
                            {% endif %}
                        </div>
                    </div>
    
                </div> {# End accordion-body #}
            </div> {# End accordion-collapse #}
        </div> {# End accordion-item #}
    
        <!-- Note Modal -->
        <div class="modal fade" id="noteModal{{ lecture_data.lecture.id }}" tabindex="-1" aria-labelledby="noteModalLabel{{ lecture_data.lecture.id }}" aria-hidden="true" data-mdb-backdrop="static" data-mdb-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="POST" action="{% url 'accounts:add_lecture_note' lecture_data.lecture.id %}" id="noteForm{{ lecture_data.lecture.id }}">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="noteModalLabel{{ lecture_data.lecture.id }}" data-translate="lecture_feedback">
                                <i class="far fa-comment-dots me-2"></i>Lecture Feedback
                            </h5>
                            <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="note{{ lecture_data.lecture.id }}" class="form-label small text-muted" data-translate="your_note">Your Note:</label>
                                <textarea class="form-control" id="note{{ lecture_data.lecture.id }}" name="note" rows="4" required></textarea>
                            </div>
    
                            {% if user_role == 'student' %}
                            <div class="mb-3">
                                <label for="rating{{ lecture_data.lecture.id }}" class="form-label small text-muted" data-translate="your_rating">Your Rating:</label>
                                <select class="form-select modal-rating-select" id="rating{{ lecture_data.lecture.id }}" name="rating" required>
                                    <option value="" disabled selected data-translate="select_rating">Select rating...</option>
                                    <option value="1">⭐ (Poor)</option>
                                    <option value="2">⭐⭐</option>
                                    <option value="3">⭐⭐⭐ (Average)</option>
                                    <option value="4">⭐⭐⭐⭐</option>
                                    <option value="5">⭐⭐⭐⭐⭐ (Excellent)</option>
                                </select>
                            </div>
                            {% endif %}
    
                            {% if user_role == 'teacher' %}
                            <div class="mb-3">
                                <label for="lecture_status{{ lecture_data.lecture.id }}" class="form-label small text-muted" data-translate="lecture_status">Lecture Status:</label>
                                <select class="form-select" id="lecture_status{{ lecture_data.lecture.id }}" name="lecture_status" required>
                                    <option value="completed" data-translate="completed">Completed Successfully</option>
                                    <option value="student_delayed" data-translate="student_delayed">Delayed by Student</option>
                                    <option value="teacher_delayed" data-translate="teacher_delayed">Delayed by Teacher</option>
                                </select>
                            </div>
    
                            {# JS Toggled field #}
                            <div class="mb-3" id="delayReasonContainer{{ lecture_data.lecture.id }}" style="display: none;">
                                <label for="delay_reason{{ lecture_data.lecture.id }}" class="form-label small text-muted" data-translate="delay_reason">Reason for Delay:</label>
                                <textarea class="form-control" id="delay_reason{{ lecture_data.lecture.id }}" name="delay_reason" rows="2"></textarea>
                            </div>
                            {% endif %}
                        </div>
                        <div class="modal-footer justify-content-between">
                            <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal" data-mdb-ripple-init data-translate="cancel">Cancel</button>
                            <button type="submit" class="btn btn-primary" data-mdb-ripple-init data-translate="submit_feedback">Submit Feedback</button>
                        </div>
                    </form> {# End Form #}
                </div>
            </div>
        </div>
    
        {# JS for teacher's modal delay reason (remains the same logic) #}
        {% if user_role == 'teacher' %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const modalElement = document.getElementById('noteModal{{ lecture_data.lecture.id }}');
                if (modalElement) {
                    const statusSelect = modalElement.querySelector('#lecture_status{{ lecture_data.lecture.id }}');
                    const reasonContainer = modalElement.querySelector('#delayReasonContainer{{ lecture_data.lecture.id }}');
                    const reasonTextarea = modalElement.querySelector('#delay_reason{{ lecture_data.lecture.id }}');
                    if (statusSelect && reasonContainer && reasonTextarea) {
                        const toggleReason = () => {
                            const isDelayed = statusSelect.value === 'student_delayed' || statusSelect.value === 'teacher_delayed';
                            reasonContainer.style.display = isDelayed ? 'block' : 'none';
                            reasonTextarea.required = isDelayed;
                            if (!isDelayed) {
                                reasonTextarea.value = '';
                            }
                        };
                        statusSelect.addEventListener('change', toggleReason);
                        toggleReason(); // Initial check
                    }
                }
            });
        </script>
        {% endif %}
    
        {% empty %}
            <div class="alert alert-secondary text-center" role="alert" data-translate="no_lectures">
                <i class="fas fa-info-circle me-2"></i> There are no lectures scheduled for this course yet.
            </div>
        {% endfor %}
    </div>
    
    <!-- Make sure MDB JS is loaded in your base template for data-mdb-* attributes to work -->
    {% else %}
        <div class="alert alert-light alert-dismissible fade show text-center mt-4">
            <i class="fas fa-info-circle me-2"></i>
            <p class="mb-0" data-translate="no_lectures">No lectures available for this study group yet.</p>
            <button type="button" class="btn-close" data-mdb-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
    
</div>






<!-- Toast Container -->
<div class="toast-wrapper position-fixed top-0 end-0 p-3" style="z-index: 1055;" id="toast-container"></div>




<!-- Add some JavaScript to handle the toggle icon rotation -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Shared Resources toggle
        const sharedResourcesHeader = document.querySelector('.card-header[data-mdb-target="#sharedResourcesCollapse"]');
        if (sharedResourcesHeader) {
            sharedResourcesHeader.addEventListener('click', function() {
                const icon = this.querySelector('.toggle-icon');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });
        }

        // Handle Add Lecture Form toggle (if it exists)
        const addLectureHeader = document.querySelector('.card-header[data-mdb-target="#addLectureFormCollapse"]');
        if (addLectureHeader) {
            addLectureHeader.addEventListener('click', function() {
                const icon = this.querySelector('.toggle-icon');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });
        }
    });
</script>



<!-- JavaScript for Dynamic Actions -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize MDB Collapse
    const collapses = document.querySelectorAll('[data-mdb-collapse-init]');
    collapses.forEach(collapse => {
        new mdb.Collapse(collapse, { toggle: false });
    });

    // Function to show toast
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastClass = type === 'success' ? 'bg-success text-white' : 'bg-danger text-white';
        const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';

        const toastHtml = `
            <div class="toast align-items-center ${toastClass} border-0 m-1" role="alert" aria-live="assertive" aria-atomic="true" style="max-width: 350px;">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="${iconClass} me-2"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-mdb-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>`;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = toastContainer.lastElementChild;
        const toastInstance = new mdb.Toast(toastEl, { autohide: true, delay: 5000 });
        toastInstance.show();

        toastEl.addEventListener('hidden.mdb.toast', function () {
            toastEl.remove();
        });
    }

    // Add Lecture
    const addLectureForm = document.getElementById('add-lecture-form');
    const addLectureButton = document.getElementById('add-lecture-button');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    if (addLectureForm) {
        addLectureForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            // Disable the button and show the spinner
            addLectureButton.disabled = true;
            buttonText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');

            fetch(`{% url 'accounts:add_lecture' study_group_id=study_group.id %}`, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    // Clear the form or update the UI as needed
                    addLectureForm.reset();
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error adding lecture: ' + error, 'error'))
            .finally(() => {
                // Re-enable the button and hide the spinner
                addLectureButton.disabled = false;
                buttonText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            });
        });
    }
    
    // File Upload
    document.querySelectorAll('.file-upload-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const lectureId = this.getAttribute('data-lecture-id');
            const fileInput = this.querySelector('input[type="file"]');
            const formData = new FormData(this);

            fetch(`{% url 'accounts:add_lecture_files' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const fileList = document.getElementById(`file-list-${lectureId}`);
                    data.files.forEach(file => {
                        const fileItem = `
                            <li class="d-flex align-items-center mb-3 file-item" data-file-id="${file.id || ''}">
                                <div class="file-icon bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="far fa-file-alt text-muted"></i>
                                </div>
                                <div class="file-info ms-3 flex-grow-1">
                                    <a href="${file.url}" class="text-decoration-none text-primary fw-bold">${file.name}</a>
                                    <div class="file-size text-muted small">${formatFileSize(file.size)}</div>
                                </div>
                                <button class="btn btn-sm btn-danger delete-file-btn" data-file-id="${file.id || ''}">Delete</button>
                            </li>`;
                        fileList.insertAdjacentHTML('beforeend', fileItem);
                    });
                    fileInput.value = '';
                    showToast(data.message, 'success');
                } else {
                    showToast('Error uploading files: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error uploading files: ' + error, 'error'));
        });
    });

    // Edit Lecture
    document.querySelectorAll('.edit-lecture-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const lectureId = this.getAttribute('data-lecture-id');
            const accordionItem = this.closest('.lecture-item');
            const title = accordionItem.querySelector('.accordion-button').textContent.trim().replace(/^.*?open me-2\}\s*/, '');
            const description = accordionItem.querySelector('.lecture-description') ? accordionItem.querySelector('.lecture-description').textContent : '';

            const formHtml = `
                <form class="edit-lecture-form px-4 py-3" data-lecture-id="${lectureId}">
                    {% csrf_token %}
                    <div class="form-outline mb-3">
                        <input type="text" name="title" class="form-control" value="${title}" required>
                        <label class="form-label">Title</label>
                    </div>
                    <div class="form-outline mb-3">
                        <textarea name="description" class="form-control" rows="3">${description}</textarea>
                        <label class="form-label">Description</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary cancel-edit">Cancel</button>
                </form>`;
            accordionItem.querySelector('.accordion-body').innerHTML = formHtml;

            const editForm = accordionItem.querySelector('.edit-lecture-form');
            editForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                // Log form data for debugging
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                fetch(`{% url 'accounts:update_lecture' lecture_id=0 %}`.replace('0', lectureId), {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                        showToast(data.message, 'success');
                    } else {
                        showToast('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => showToast('Error updating lecture: ' + error, 'error'));
            });

            editForm.querySelector('.cancel-edit').addEventListener('click', function () {
                location.reload();
            });
        });
    });

    // Delete Lecture
    document.querySelectorAll('.delete-lecture-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (!confirm('Are you sure you want to delete this lecture?')) return;
            const lectureId = this.getAttribute('data-lecture-id');
            const accordionItem = this.closest('.accordion-item');

            fetch(`{% url 'accounts:delete_lecture' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    accordionItem.remove();
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error deleting lecture: ' + error, 'error'));
        });
    });

    // Reschedule Lecture
    document.querySelectorAll('.reschedule-lecture-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (!confirm('Are you sure you want to reschedule this lecture to now?')) return;
            const lectureId = this.getAttribute('data-lecture-id');
            const accordionItem = this.closest('.accordion-item');

            fetch(`{% url 'accounts:reschedule_lecture' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const liveSessionDiv = accordionItem.querySelector('.live-session') || document.createElement('div');
                    if (!liveSessionDiv.classList.contains('live-session')) {
                        liveSessionDiv.classList.add('live-session');
                        accordionItem.querySelector('.d-flex').appendChild(liveSessionDiv);
                    }
                    liveSessionDiv.innerHTML = `
                        <i class="fas fa-video me-1 text-primary"></i>
                        <a href="${data.live_link}" class="btn btn-sm btn-primary px-3 ripple-surface live-link">Join Live Session</a>`;
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error rescheduling lecture: ' + error, 'error'));
        });
    });

    // Delete File
    document.querySelectorAll('.delete-file-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (!confirm('Are you sure you want to delete this file?')) return;
            const fileId = this.getAttribute('data-file-id');

            fetch(`{% url 'accounts:delete_lecture_file' file_id=0 %}`.replace('0', fileId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`.file-item[data-file-id="${fileId}"]`).remove();
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error deleting file: ' + error, 'error'));
        });
    });

    // Mark Lecture as Finished
    document.querySelectorAll('.mark-finished-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const lectureId = this.getAttribute('data-lecture-id');
            fetch(`{% url 'accounts:mark_lecture_as_finished' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const accordionHeader = this.closest('.accordion-item').querySelector('.accordion-header');
                    const accordionButton = accordionHeader.querySelector('.accordion-button');
                    
                    // Add the finished class to the header
                    accordionHeader.classList.add('finished-lecture');
                    
                    // Add the finished badge if it doesn't exist
                    if (!accordionButton.querySelector('.badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-danger ms-2';
                        badge.textContent = 'Finished';
                        accordionButton.appendChild(badge);
                    }
                    
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error marking lecture as finished: ' + error, 'error'));
        });
    });

    // File Size Formatting
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }



    const noteButtons = document.querySelectorAll('[data-mdb-toggle="modal"][data-mdb-target^="noteModal"]');
        noteButtons.forEach(button => {
            button.addEventListener('click', event => {
                const lectureId = button.getAttribute('data-lecture-id');
                const modal = document.querySelector(button.getAttribute('data-mdb-target'));
                const noteForm = modal.querySelector('form');
                // Ensure the form action is set correctly (though it should already be set in the template)
                noteForm.action = noteForm.action.replace('0', lectureId);
            });
    });

    // Handle shared resource deletion
    document.querySelectorAll('.delete-resource-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const resourceId = this.dataset.resourceId;
            if (!confirm('Are you sure you want to delete this shared resource?')) return;
            
            try {
                const response = await fetch(`{% url 'accounts:delete_shared_resource' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        resource_id: resourceId
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.closest('tr').remove();
                    showToast('Resource deleted successfully', 'success');
                } else {
                    throw new Error(data.message || 'Failed to delete resource');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message, 'danger');
            }
        });
    });

});


</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    
        // --- Configuration for Collapsible Sections ---
        // Add entries here for any new collapsible sections you create
        const collapsibleSections = [
            {
                headerId: 'sharedResourcesHeader',
                collapseId: 'sharedResourcesCollapse',
                storageKey: 'sharedResourcesCollapsed'
            },
            {
                headerId: 'addLectureHeader',
                collapseId: 'addLectureFormCollapse',
                storageKey: 'addLectureFormCollapsed'
            }
            // Add more sections like this:
            // { headerId: 'anotherHeaderId', collapseId: 'anotherCollapseId', storageKey: 'anotherCollapsedStateKey' }
        ];
    
        // --- Generic Function to Update Toggle Icon ---
        const updateToggleIcon = (iconElement, isCollapsing) => {
            if (!iconElement) return; // Safety check if icon isn't found
            if (isCollapsing) {
                // It's going to be hidden (or is hidden) -> show 'up' arrow
                iconElement.classList.remove('fa-chevron-down');
                iconElement.classList.add('fa-chevron-up');
            } else {
                // It's going to be shown (or is shown) -> show 'down' arrow
                iconElement.classList.remove('fa-chevron-up');
                iconElement.classList.add('fa-chevron-down');
            }
        };
    
        // --- Loop through each configured section and apply logic ---
        collapsibleSections.forEach(section => {
            const headerElement = document.getElementById(section.headerId);
            const collapseElement = document.getElementById(section.collapseId);
            const toggleIconElement = headerElement ? headerElement.querySelector('.toggle-icon') : null;
    
            // Check if elements exist before proceeding
            if (!headerElement || !collapseElement || !toggleIconElement) {
                console.warn(`Could not find all elements for collapsible section:`, section);
                return; // Skip this section if elements are missing
            }
    
            // --- Set Initial State on Page Load ---
            const isCollapsedInitially = localStorage.getItem(section.storageKey) === 'true';
    
            if (isCollapsedInitially) {
                // If localStorage says collapsed, ensure it is (remove 'show')
                collapseElement.classList.remove('show');
                updateToggleIcon(toggleIconElement, true); // Set icon to 'up'
                headerElement.setAttribute('aria-expanded', 'false');
            } else {
                // If localStorage says expanded (or no value), ensure it has 'show'
                // Note: Only add if not already present, though add() is safe
                if (!collapseElement.classList.contains('show')) {
                     collapseElement.classList.add('show');
                }
                updateToggleIcon(toggleIconElement, false); // Set icon to 'down'
                headerElement.setAttribute('aria-expanded', 'true');
            }
    
            // --- Listen for MDB/Bootstrap Collapse Events ---
    
            // Event listener for AFTER it has been shown (expanded)
            collapseElement.addEventListener('shown.bs.collapse', function () {
                localStorage.setItem(section.storageKey, 'false'); // It's now expanded
                updateToggleIcon(toggleIconElement, false);       // Update icon to 'down'
                headerElement.setAttribute('aria-expanded', 'true'); // Sync aria
            });
    
            // Event listener for AFTER it has been hidden (collapsed)
            collapseElement.addEventListener('hidden.bs.collapse', function () {
                localStorage.setItem(section.storageKey, 'true'); // It's now collapsed
                updateToggleIcon(toggleIconElement, true);        // Update icon to 'up'
                headerElement.setAttribute('aria-expanded', 'false'); // Sync aria
            });
        });
    
    });
    </script>


{% endblock %}