{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block translationFolder %}data-translation-folder="lectures"{% endblock %}
{% block title %}Lectures{% endblock %}




{% block content %}

<style>
    .active-lecture{
        background-color: #fff0f0; /* light red background */
        border-left: 4px solid #28a745; /* red border */
    }
    
    .active-lecture .accordion-button {
        color: #28a745; /* red text */
    }


    .finished-lecture {
        background-color: #f0fff0; /* light green background */
        border-left: 4px solid #dc3545; /* green border */
    }
    
    .finished-lecture .accordion-button {
        color: #dc3545; /* green text */
    }
</style>


<!-- Add this inside the lecture loop in your template -->
<div class="container mt-5">
    <!-- Add Lecture Form (Teacher Only) -->
    {% if user_role == 'teacher' %}
    <div class="card mb-4 shadow-sm" style="background-color: #f2fdfa;">
        <div class="card-body">
            <form id="add-lecture-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="add_lecture" value="1">
                <div class="row g-3">
                    <div class="col-md-5">
                        <div class="form-floating">
                            <input type="text" id="{{ lecture_form.title.id_for_label }}" name="title" class="form-control" value="{{ lecture_form.title.value|default:'' }}" required>
                            <label class="form-label" for="{{ lecture_form.title.id_for_label }}" data-translate="title">Title</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="number" id="{{ lecture_form.duration.id_for_label }}" name="duration" class="form-control" value="{{ lecture_form.duration.value|default:60 }}" max="300" min="10" required>
                            <label class="form-label" for="{{ lecture_form.duration.id_for_label }}" data-translate="duration">Duration (minutes)</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <select id="{{ lecture_form.schedule.id_for_label }}" name="schedule" class="form-select" required>
                                {% for value, label in lecture_form.schedule.field.choices %}
                                    <option value="{{ value }}" {% if lecture_form.schedule.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <label class="form-label" for="{{ lecture_form.schedule.id_for_label }}" data-translate="schedule">Schedule</label>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="form-floating">
                            <textarea id="{{ lecture_form.description.id_for_label }}" name="description" class="form-control" rows="3" required>{{ lecture_form.description.value|default:'' }}</textarea>
                            <label class="form-label" for="{{ lecture_form.description.id_for_label }}" data-translate="description">Description</label>
                        </div>
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" id="add-lecture-button" class="btn btn-primary btn-block btn-rounded">
                            <span id="button-text" data-translate="add_lecture">Add Lecture</span>
                            <div id="loading-spinner" class="spinner-border spinner-border-sm d-none" role="status">
                                <span class="visually-hidden" data-translate="loading">Loading...</span>
                            </div>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Lectures List with MDB Accordion -->
    {% if lectures_with_files %}
        <div class="accordion" id="lecturesAccordion">
            {% for lecture_data in lectures_with_files %}
            <div class="accordion-item lecture-item" data-lecture-id="{{ lecture_data.lecture.id }}">
                <h2 class="accordion-header {% if lecture_data.lecture.is_finished %}finished-lecture {% else %} active-lecture {% endif %}" id="heading{{ forloop.counter }}">
                    <button
                        data-mdb-collapse-init
                        class="accordion-button collapsed"
                        type="button"
                        data-mdb-toggle="collapse"
                        data-mdb-target="#collapse{{ forloop.counter }}"
                        aria-expanded="false"
                        aria-controls="collapse{{ forloop.counter }}"
                    >
                        <i class="fas fa-book-open me-2"></i> {{ lecture_data.lecture.title }}
                        {% if lecture_data.lecture.is_finished %}
                            <span class="badge bg-danger ms-2" data-translate="finished">Finished</span>
                        {% endif %}
                    </button>
                </h2>
                    <div
                        id="collapse{{ forloop.counter }}"
                        class="accordion-collapse collapse"
                        aria-labelledby="heading{{ forloop.counter }}"
                        data-mdb-parent="#lecturesAccordion"
                    >
                        <div class="accordion-body">
                            <p class="text-muted mb-4 lecture-description" data-translate="lecture_description">{{ lecture_data.lecture.description }}</p>
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="date-info">
                                    <i class="far fa-calendar-alt me-1 text-muted"></i>
                                    <small class="text-muted" data-translate="created_on">Created on:</small>
                                    {{ lecture_data.lecture.created|date:"m/d/Y" }}
                                </div>
                                {% if lecture_data.lecture.live_link %}
                                <div class="live-session">
                                    <i class="fas fa-video me-1 text-primary"></i>
                                    <a href="lecture_data.lecture.live_link" class="btn btn-sm btn-primary px-3 ripple-surface live-link" data-translate="join_live_session">Join Live Session</a>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Files Section -->
                            <div class="lecture-files">
                                <h5 class="mb-3 text-secondary"><i class="fas fa-paperclip me-2"></i> <span data-translate="files">Files:</span></h5>
                                <ul class="list-unstyled" id="file-list-{{ lecture_data.lecture.id }}">
                                    {% for file in lecture_data.files %}
                                        <li class="d-flex align-items-center mb-3 file-item" data-file-id="{{ file.id }}">
                                            <div class="file-icon bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="far fa-file-alt text-muted"></i>
                                            </div>
                                            <div class="file-info ms-3 flex-grow-1">
                                                <a href="{{ file.file.url }}" class="text-decoration-none text-primary fw-bold">
                                                    {{ file.file.name|split:"/"|last }}
                                                </a>
                                                <div class="file-size text-muted small" data-translate="file_size">{{ file.file.size|filesizeformat }}</div>
                                            </div>
                                            {% if user_role == 'teacher' %}
                                                <button class="btn btn-sm btn-danger delete-file-btn" data-file-id="{{ file.id }}" data-translate="delete">Delete</button>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>

                                <!-- Add File Form and Actions (Teacher Only) -->
                                {% if user_role == 'teacher' %}
                                    <form class="mt-3 file-upload-form" data-lecture-id="{{ lecture_data.lecture.id }}">
                                        {% csrf_token %}
                                        <div class="input-group">
                                            <input type="file" name="file" class="form-control" multiple>
                                            <button type="submit" class="btn btn-outline-primary" data-translate="upload_files">Upload Files</button>
                                        </div>
                                    </form>
                                    <div class="mt-3 lecture-actions">
                                        <button class="btn btn-warning edit-lecture-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-translate="edit">Edit</button>
                                        <button class="btn btn-info reschedule-lecture-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-translate="reschedule">Reschedule</button>
                                        {% if not lecture_data.lecture.is_finished %}
                                        <button class="btn btn-success mark-finished-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-translate="mark_as_finished">Mark as Finished</button>
                                        {% endif %}
                                        <button class="btn btn-danger delete-lecture-btn" data-lecture-id="{{ lecture_data.lecture.id }}" data-translate="delete">Delete</button>
                                        <!-- Note Button and Modal -->
                                        {% if not lecture_data.note %}
                                        <button type="button" class="btn btn-secondary text-light mt-3" data-mdb-toggle="modal" data-mdb-target="#noteModal{{ lecture_data.lecture.id }}" data-translate="add_note">Add Note</button>
                                        {% else %}
                                        <p class="mt-3" data-translate="note_added">Note Added</p>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {% if user_role == 'student' %}
                                    <!-- Note Button and Modal -->
                                    {% if not lecture_data.note %}
                                    <button type="button" class="btn btn-secondary text-light mt-3" data-mdb-toggle="modal" data-mdb-target="#noteModal{{ lecture_data.lecture.id }}" data-translate="add_note">Add Note</button>
                                    {% else %}
                                    <p class="mt-3" data-translate="note_added">Note Added</p>
                                    {% endif %}
                                {% endif %}
                            </div>

                            

                            <div class="modal fade" id="noteModal{{ lecture_data.lecture.id }}" tabindex="-1" aria-labelledby="noteModalLabel{{ lecture_data.lecture.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="noteModalLabel{{ lecture_data.lecture.id }}" data-translate="add_note">Add Note</h5>
                                        <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form method="POST" action="{% url 'accounts:add_lecture_note' lecture_data.lecture.id %}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="note{{ lecture_data.lecture.id }}" class="form-label" data-translate="note">Note</label>
                                                <textarea class="form-control" id="note{{ lecture_data.lecture.id }}" name="note" rows="3" required></textarea>
                                            </div>
                                            {% if user_role == 'student' %}
                                            <div class="mb-3">
                                                <label for="rating{{ lecture_data.lecture.id }}" class="form-label" data-translate="rating">Rating</label>
                                                <select class="form-select" id="rating{{ lecture_data.lecture.id }}" name="rating" required>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                </select>
                                            </div>
                                            {% endif %}
                                            <button type="submit" class="btn btn-primary" data-translate="submit">Submit</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            </div>

                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-light alert-dismissible fade show text-center mt-4">
            <i class="fas fa-info-circle me-2"></i>
            <p class="mb-0" data-translate="no_lectures">No lectures available for this study group yet.</p>
            <button type="button" class="btn-close" data-mdb-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
</div>



<!-- Toast Container -->
<div class="toast-wrapper position-fixed top-0 end-0 p-3" style="z-index: 1055;" id="toast-container"></div>


<!-- JavaScript for Dynamic Actions -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize MDB Collapse
    const collapses = document.querySelectorAll('[data-mdb-collapse-init]');
    collapses.forEach(collapse => {
        new mdb.Collapse(collapse, { toggle: false });
    });

    // Function to show toast
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastClass = type === 'success' ? 'bg-success text-white' : 'bg-danger text-white';
        const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';

        const toastHtml = `
            <div class="toast align-items-center ${toastClass} border-0 m-1" role="alert" aria-live="assertive" aria-atomic="true" style="max-width: 350px;">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="${iconClass} me-2"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-mdb-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>`;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = toastContainer.lastElementChild;
        const toastInstance = new mdb.Toast(toastEl, { autohide: true, delay: 5000 });
        toastInstance.show();

        toastEl.addEventListener('hidden.mdb.toast', function () {
            toastEl.remove();
        });
    }

    // Add Lecture
    const addLectureForm = document.getElementById('add-lecture-form');
    const addLectureButton = document.getElementById('add-lecture-button');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    if (addLectureForm) {
        addLectureForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            // Disable the button and show the spinner
            addLectureButton.disabled = true;
            buttonText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');

            fetch(`{% url 'accounts:add_lecture' study_group_id=study_group.id %}`, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    // Clear the form or update the UI as needed
                    addLectureForm.reset();
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error adding lecture: ' + error, 'error'))
            .finally(() => {
                // Re-enable the button and hide the spinner
                addLectureButton.disabled = false;
                buttonText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            });
        });
    }
    
    // File Upload
    document.querySelectorAll('.file-upload-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const lectureId = this.getAttribute('data-lecture-id');
            const fileInput = this.querySelector('input[type="file"]');
            const formData = new FormData(this);

            fetch(`{% url 'accounts:add_lecture_files' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const fileList = document.getElementById(`file-list-${lectureId}`);
                    data.files.forEach(file => {
                        const fileItem = `
                            <li class="d-flex align-items-center mb-3 file-item" data-file-id="${file.id || ''}">
                                <div class="file-icon bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="far fa-file-alt text-muted"></i>
                                </div>
                                <div class="file-info ms-3 flex-grow-1">
                                    <a href="${file.url}" class="text-decoration-none text-primary fw-bold">${file.name}</a>
                                    <div class="file-size text-muted small">${formatFileSize(file.size)}</div>
                                </div>
                                <button class="btn btn-sm btn-danger delete-file-btn" data-file-id="${file.id || ''}">Delete</button>
                            </li>`;
                        fileList.insertAdjacentHTML('beforeend', fileItem);
                    });
                    fileInput.value = '';
                    showToast(data.message, 'success');
                } else {
                    showToast('Error uploading files: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error uploading files: ' + error, 'error'));
        });
    });

    // Edit Lecture
    document.querySelectorAll('.edit-lecture-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const lectureId = this.getAttribute('data-lecture-id');
            const accordionItem = this.closest('.lecture-item');
            const title = accordionItem.querySelector('.accordion-button').textContent.trim().replace(/^.*?open me-2\}\s*/, '');
            const description = accordionItem.querySelector('.lecture-description') ? accordionItem.querySelector('.lecture-description').textContent : '';

            const formHtml = `
                <form class="edit-lecture-form px-4 py-3" data-lecture-id="${lectureId}">
                    {% csrf_token %}
                    <div class="form-outline mb-3">
                        <input type="text" name="title" class="form-control" value="${title}" required>
                        <label class="form-label">Title</label>
                    </div>
                    <div class="form-outline mb-3">
                        <textarea name="description" class="form-control" rows="3">${description}</textarea>
                        <label class="form-label">Description</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary cancel-edit">Cancel</button>
                </form>`;
            accordionItem.querySelector('.accordion-body').innerHTML = formHtml;

            const editForm = accordionItem.querySelector('.edit-lecture-form');
            editForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                // Log form data for debugging
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                fetch(`{% url 'accounts:update_lecture' lecture_id=0 %}`.replace('0', lectureId), {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                        showToast(data.message, 'success');
                    } else {
                        showToast('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => showToast('Error updating lecture: ' + error, 'error'));
            });

            editForm.querySelector('.cancel-edit').addEventListener('click', function () {
                location.reload();
            });
        });
    });

    // Delete Lecture
    document.querySelectorAll('.delete-lecture-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (!confirm('Are you sure you want to delete this lecture?')) return;
            const lectureId = this.getAttribute('data-lecture-id');
            const accordionItem = this.closest('.accordion-item');

            fetch(`{% url 'accounts:delete_lecture' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    accordionItem.remove();
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error deleting lecture: ' + error, 'error'));
        });
    });

    // Reschedule Lecture
    document.querySelectorAll('.reschedule-lecture-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (!confirm('Are you sure you want to reschedule this lecture to now?')) return;
            const lectureId = this.getAttribute('data-lecture-id');
            const accordionItem = this.closest('.accordion-item');

            fetch(`{% url 'accounts:reschedule_lecture' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const liveSessionDiv = accordionItem.querySelector('.live-session') || document.createElement('div');
                    if (!liveSessionDiv.classList.contains('live-session')) {
                        liveSessionDiv.classList.add('live-session');
                        accordionItem.querySelector('.d-flex').appendChild(liveSessionDiv);
                    }
                    liveSessionDiv.innerHTML = `
                        <i class="fas fa-video me-1 text-primary"></i>
                        <a href="${data.live_link}" class="btn btn-sm btn-primary px-3 ripple-surface live-link">Join Live Session</a>`;
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error rescheduling lecture: ' + error, 'error'));
        });
    });

    // Delete File
    document.querySelectorAll('.delete-file-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (!confirm('Are you sure you want to delete this file?')) return;
            const fileId = this.getAttribute('data-file-id');

            fetch(`{% url 'accounts:delete_lecture_file' file_id=0 %}`.replace('0', fileId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`.file-item[data-file-id="${fileId}"]`).remove();
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error deleting file: ' + error, 'error'));
        });
    });

    // Mark Lecture as Finished
    document.querySelectorAll('.mark-finished-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const lectureId = this.getAttribute('data-lecture-id');
            fetch(`{% url 'accounts:mark_lecture_as_finished' lecture_id=0 %}`.replace('0', lectureId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const accordionHeader = this.closest('.accordion-item').querySelector('.accordion-header');
                    const accordionButton = accordionHeader.querySelector('.accordion-button');
                    
                    // Add the finished class to the header
                    accordionHeader.classList.add('finished-lecture');
                    
                    // Add the finished badge if it doesn't exist
                    if (!accordionButton.querySelector('.badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-danger ms-2';
                        badge.textContent = 'Finished';
                        accordionButton.appendChild(badge);
                    }
                    
                    showToast(data.message, 'success');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => showToast('Error marking lecture as finished: ' + error, 'error'));
        });
    });

    // File Size Formatting
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }



    const noteButtons = document.querySelectorAll('[data-mdb-toggle="modal"][data-mdb-target^="noteModal"]');
        noteButtons.forEach(button => {
            button.addEventListener('click', event => {
                const lectureId = button.getAttribute('data-lecture-id');
                const modal = document.querySelector(button.getAttribute('data-mdb-target'));
                const noteForm = modal.querySelector('form');
                // Ensure the form action is set correctly (though it should already be set in the template)
                noteForm.action = noteForm.action.replace('0', lectureId);
            });
        });

});




</script>
{% endblock %}